# 财政工资数据处理工具 - 使用说明 🧰

### 1. 简介 🎯

本工具旨在自动化处理财政部门的工资数据，能够合并源工资表与扣款明细，根据灵活的映射规则转换字段，执行复杂的计算（如扣发合计、补发工资、实发工资），并最终生成符合指定格式要求的工资发放表。

**核心功能**: ✨

*   **数据合并**: 自动合并多个源工资表与统一的扣款明细表。
*   **字段映射**: 根据配置规则，将源文件中的字段名转换为标准输出字段名。
*   **复杂计算**: 支持基于多个源字段进行加总或其他自定义计算，生成新的目标字段。
*   **格式化输出**: 按照预定义的 Excel 模板精确控制输出文件的列顺序和包含的字段。
*   **用户界面**: 提供简单的 Web 界面 (Streamlit) 进行文件上传和任务配置。

### 2. 准备工作 ⚙️

*   **运行环境**: 需要安装 Python (推荐 3.8 或更高版本) 🐍。
*   **依赖库**: 工具依赖 Pandas, Streamlit, Openpyxl 等库。如果您使用的是包含环境的部署包，通常无需手动安装。
*   **启动工具**: 在项目根目录下，通过命令行运行 `streamlit run app.py` 来启动 Web 用户界面 🚀。

### 3. 文件结构 📁

项目包含以下关键目录和文件：

*   `app.py`: Streamlit 应用的主程序文件。
*   `fiscal_report_full_script.py`: 包含核心数据处理逻辑的脚本。
*   `config/`: 存放配置文件的目录。
    *   `config.json`: ⚙️ 主配置文件，指定各种路径和关键参数。
    *   `output_template.xlsx`: 📄 定义最终输出文件格式的模板。
    *   `field_mapping/`: 存放字段映射规则的 JSON 文件。
        *   例如: `公务员-参公-事业.json` (根据实际文件名修改)
*   `input/`: (建议) 📂 用于存放待处理的源工资表和扣款明细表。
*   `output/`: (建议) 📤 用于存放工具处理后生成的工资发放表。
*   `streamlit_app.log`: 📝 工具运行时产生的日志文件，用于问题排查。

### 4. 输入文件详解 📄

**4.1 文件清单 ✅**

运行工具前，请确保以下文件已准备就绪并放置在合适的路径（建议放在 `input/` 目录，并在 `config.json` 中正确配置路径）：

1.  **源工资表文件**:
    *   一个或多个 Excel 文件 (`.xlsx`)。
    *   文件名示例: `参公工资表-202409.xlsx`, ` 公务员工资表-202409.xlsx`
2.  **扣款明细表文件**:
    *   一个 Excel 文件 (`.xlsx`)。
    *   文件名示例: `公务员-参公-事业-扣款项-202409.xlsx`
3.  **主配置文件**:
    *   `config/config.json`
4.  **字段映射规则文件**:
    *   位于 `config/field_mapping/` 目录下的一个或多个 JSON 文件。
    *   文件名示例: `字段匹配-公务员-参公-事业.json`
5.  **输出模板文件**:
    *   `config/公务员-参公-事业-大平台表-模板xlsx`

**4.2 文件格式标准 📏**

*   **源工资表 (`.xlsx`)**
    *   **格式**: Microsoft Excel (`.xlsx`)。
    *   **表头**: **❗ 重要：** 表头行（包含字段名，如"序号"、"姓名"、"人员身份"等）**必须**位于文件的**第三行**（即 Excel 中显示的行号为 3）。第一行和第二行可用于存放标题、制表单位、日期等信息，这些行将被忽略。
    *   **数据起始**: 实际的数据记录应紧跟在第三行表头之后，从第四行开始。
    *   **必需列**:
        *   `人员身份` 列（或 `config.json` 中指定的 `source_identity_column`）：必须存在于第三行的表头中，用于匹配 `field_mapping` 规则。
        *   `姓名` 或 `人员姓名` 列：必须存在于第三行的表头中，用于与扣款表合并。
        *   所有在 `field_mapping` 规则中被引用的 `source_field` 或 `source_fields` 都必须存在于第三行的表头中，且列名完全匹配。
    *   **数据类型**: 参与计算的列（如 `职务工资`, `级别工资`, `一次性补扣发` 等）应尽量为数值类型 🔢。
    *   **特殊行**: 工具会自动过滤掉 `人员身份` 列（或指定列）中包含 "合计", "汇总", "总计", "备注", "说明" 等关键字的数据行（从第四行开始的数据行）。

*   **扣款明细表 (`.xlsx`)**
    *   **格式**: Microsoft Excel (`.xlsx`)。
    *   **表头**: **❗ 重要：** 表头行（包含字段名，如"人员姓名"、"个人缴养老保险费"等）**必须**位于文件的**第三行**（即 Excel 中显示的行号为 3）。
    *   **数据起始**: 实际的扣款数据应紧跟在第三行表头之后，从第四行开始。
    *   **必需列**:
        *   `姓名` 或 `人员姓名` 列：必须存在于第三行的表头中，用于与源工资表合并。
        *   所有需要在最终报表中展示或参与计算的扣款字段列（如 `个人缴养老保险费`, `个人所得税`, `其他补扣` 等）：必须存在于第三行的表头中。
    *   **数据类型**: 所有扣款金额列必须是**数值类型** 🔢。
    *   **唯一性**: 每个 `姓名`/`人员姓名` 在扣款数据区域（从第四行开始）中理论上应该是唯一的。

*   **主配置文件 (`config.json`)** ⚙️
    *   **格式**: JSON。
    *   **关键配置项**:
        *   `deduction_table_path`: 指向扣款明细表文件的**相对或绝对路径**。
        *   `field_mapping_dir`: 指向存放字段映射规则 JSON 文件的**目录路径**。
        *   `source_files_dir`: 指向存放源工资表文件的**目录路径**。
        *   `output_dir`: 指定处理结果文件输出的**目录路径**。
        *   `output_template_path`: 指向输出模板 Excel 文件的**路径**。
        *   `source_identity_column`: 指定源工资表中用于识别人员身份并匹配映射规则的列名（通常是 `人员身份`）。
        *   `rule_identity_key`: 指定字段映射 JSON 文件中代表人员身份的那个键名（通常也是 `人员身份`）。

*   **字段映射规则文件 (`config/field_mapping/*.json`)** 📝
    *   **格式**: JSON 文件，其文件名会显示在 UI 的下拉选择框中。文件内容是一个 JSON 列表 `[]`，列表中的每个元素是一个代表特定人员身份规则的对象 `{}`。
    *   **规则对象结构**:
        ```json
        {
          "人员身份": "参公人员",
          "编制": "参公",
          "岗位类别": "参公人员",
          "mappings": [
            { "source_field": "源列A", "target_field": "目标列X" },
            { "source_fields": ["源列B", "源列C"], "target_field": "目标列Y", "calculation": "sum" },
            { "source_fields": ["目标列X", "目标列Y"], "target_field": "目标列Z", "calculation": "目标列X + 目标列Y * 0.1" }
          ]
        }
        ```
    *   **❗ 重要**:
        *   `人员身份` (或 `rule_identity_key` 指定的键) 的值必须与源工资表 `source_identity_column` 列中的值**完全一致**才能匹配规则。
        *   `source_field` 和 `source_fields` 中的列名必须与**Excel 第三行表头**或**之前计算生成的中间结果列**的名称**完全一致**。
        *   `target_field` 是最终输出或中间计算结果的列名。
        *   包含 `source_fields` 的规则是复杂计算规则。

    *   **💡 映射规则类型示例**: 
        
        1.  **简单映射 (Simple Mapping)**: 直接将一个源列的值复制到目标列。
            ```json
            { 
              "source_field": "职务/技术等级 工资", 
              "target_field": "职务工资" 
            }
            ```
            *说明*: 将源 Excel 文件第三行表头中名为 "职务/技术等级 工资" 的列，在输出时重命名为 "职务工资"。

        2.  **求和计算 (Sum Calculation)**: 将多个源列的值按行相加，结果存入目标列。
            ```json
            { 
              "source_fields": ["个人缴养老保险费", "个人缴医疗保险费", "个人缴职业年金", "个人缴失业保险费", "个人缴住房公积金", "个人所得税"], 
              "target_field": "扣发合计", 
              "calculation": "sum" 
            }
            ```
            *说明*: 将 "个人缴养老保险费"、"个人缴医疗保险费" 等多个字段的值按行加起来，结果放入名为 "扣发合计" 的新列中。

        3.  **表达式计算 (Expression Calculation)**: 使用 Python 表达式，基于一个或多个源列的值计算出目标列的值。
            ```json
            { 
              "source_fields": ["应发工资", "扣发合计", "其他补扣"], 
              "target_field": "实发工资", 
              "calculation": "应发工资 - 扣发合计 - 其他补扣" 
            }
            ```
            *说明*: 通过计算 "应发工资" 减去 "扣发合计" 再减去 "其他补扣" 的值，得到 "实发工资" 列。注意这里的 `source_fields` ("扣发合计", "其他补扣") 可能本身就是通过其他规则计算出来的中间结果。

*   **输出模板文件 (`config/output_template.xlsx`)** 📄➡️📊
    *   **格式**: Microsoft Excel (`.xlsx`)。
    *   **内容**: 只需包含**一行表头**（位于**第一行即可**）。这一行定义了最终输出文件 `*_已处理.xlsx` 中**应该包含哪些列**以及它们的**排列顺序**。
    *   **作用**: 工具会严格按照此模板的表头来筛选和排序最终输出的列。不在模板表头中的列将被丢弃。

### 5. 操作步骤 ▶️

1.  **启动应用**: 在项目根目录下打开终端或命令行，运行 `streamlit run app.py` 🚀。
2.  **上传所需文件**
    1. **上传源工资表**: 点击 "源数据工资表" 上传按钮 📤，选择文件，可上传多个文件。
    2.  **上传目标表模板**: 点击 "导出表字段模板" 上传按钮，选择文件。
    3.  **上传扣款项表**: 点击 "扣款项表" 上传按钮，选择文件。
    4.  **上传字段映射文件**: 点击 "字段映射规则" 上传按钮，选择文件。
3.  **开始处理**: 点击 "开始处理" 按钮 ▶️。工具将按顺序执行处理流程。
4.  **监控进度**: 界面会显示处理日志 ⏱️，您可以实时了解处理进度和潜在的警告或错误信息。详细日志也会写入 `streamlit_app.log` 文件 📝。
5.  **下载结果**: 处理成功完成后 ✅，界面会显示 "处理成功完成！" 的消息，并提供一个 "下载已处理文件" 的按钮 📥。点击即可下载生成的 `*_已处理.xlsx` 文件。

### 6. 输出文件 📊

*   **格式**: Microsoft Excel (`.xlsx`)。
*   **内容**: 包含所有处理过的人员数据。
*   **列结构**: 完全由 `config/output_template.xlsx` 文件定义。
*   **关键计算列**:
    *   `扣发合计`: 根据规则从各项扣款明细加总。
    *   `补发工资` (或类似): 根据规则从各项补发/补扣字段加总。
    *   `实发工资`: 根据规则通过 `应发工资`、`扣发合计` 等计算。

### 7. 注意事项与常见问题排查 ⚠️❓

*   **⚠️ 姓名匹配**: 确保源工资表和扣款表中的姓名列（`姓名` 或 `人员姓名`）能够匹配。检查空格、特殊字符。
*   **⚠️ 字段名完全匹配**: 配置文件和 JSON 规则中的列名必须与 Excel 文件**第三行表头**的列名**大小写、空格完全一致**。
*   **⚠️ 人员身份匹配**: 源工资表中的 `人员身份` 值必须与 JSON 规则中的身份标识**完全一致**。
*   **⚠️ 数据类型**: 确保 Excel 中需计算的列是数值类型 🔢。
*   **❓ NaN/空值结果**: 计算结果为空或 NaN？常见原因：
    *   合并失败（姓名不匹配）。
    *   源字段不存在或在处理中丢失（检查文件和映射规则）。
    *   源字段值为文本。
*   **💡 检查日志**: 遇到问题，请首先查看界面日志和 `streamlit_app.log` 文件 📝。
*   **💡 备份配置**: 修改 `.json` 或 `config.json` 前，建议备份。

### 8. 配置说明 (进阶) 💡

*   **`config.json`** ⚙️:
    *   关注路径设置，以及 `source_identity_column` 和 `rule_identity_key` 的正确性。
*   **字段映射 (`field_mapping/*.json`)** 📝:
    *   **静态字段**: 规则对象顶层的键值对会被直接添加。
    *   **简单映射**: `"source_field"` -> `