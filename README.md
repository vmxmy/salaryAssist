# 🏢 Excel 字段转换数据处理与合并工具

## 📋 项目介绍

该项目是一个基于Streamlit开发的Web应用程序，用于处理、合并和格式化工资数据。系统可以处理多个工资表文件，根据配置的字段映射规则转换字段名称，合并扣款表数据，并生成格式统一的Excel报表。

### 🎯 主要目标：
- 📊 简化多源工资数据处理流程
- 🔄 统一不同来源数据的字段格式
- 🔗 自动合并工资和扣款数据
- ✨ 生成标准化、美观的工资发放表

---

## 🛠️ 功能说明

### ⚙️ 核心功能

1. **📄 多源工资表处理**
   - ✅ 支持同时上传并处理多个Excel工资表
   - 🔍 自动识别表头位置和数据起始行
   - 🧹 过滤掉合计/汇总行等非数据行

2. **🔧 灵活的字段映射系统**
   - 📝 通过JSON配置文件定义字段映射规则
   - 👥 支持基于人员身份/岗位类别的差异化映射
   - 🔄 支持简单映射（字段对字段）和复杂映射（多字段计算）

3. **📎 扣款数据合并**
   - 🔗 自动与扣款表进行数据合并
   - 🧠 智能匹配姓名/人员姓名字段
   - ⭐ 优先使用扣款表中的数据

4. **🧮 自动计算功能**
   - 📊 根据规则计算复杂字段（如扣发合计）
   - 💰 自动计算实发工资
   - ➗ 支持自定义计算公式

5. **📑 格式化输出**
   - 📋 生成标准化的Excel报表
   - 📅 自动设置标题、日期和单位名称
   - 🎨 根据字段类型应用不同样式（基本信息、统计信息、收入、扣除）
   - 📐 自动调整列宽，隐藏空列，冻结窗格

6. **⚙️ 映射规则编辑与验证**
   - 📊 可视化展示映射规则统计
   - ✏️ 支持在线编辑和验证映射规则
   - 💾 提供规则下载和保存功能

### 💻 用户界面

- ⚙️ 参数设置侧边栏（单位名称、工资表日期）
- 📂 文件上传区（源数据、模板、扣款表、映射规则）
- 🔄 字段匹配设置
- 📝 映射规则编辑与可视化
- 📝 处理日志实时显示
- ⏳ 处理进度反馈
- 📥 结果下载功能

---

## 🚀 部署方法

### 🖥️ 方法一：直接运行（命令行）

#### 📋 前提条件
- 🐍 Python 3.12+ (推荐, 基于 Dockerfile)
- 📦 pip（Python包管理器）

#### 📥 安装步骤
1. 📋 克隆或下载项目到本地
2. 📂 进入项目目录
3. 📦 安装依赖
   ```bash
   pip install -r requirements.txt
   ```
4. 🚀 运行应用
   - Linux/Mac:
     ```bash
     ./run.sh
     ```
     或
     ```bash
     streamlit run app.py
     ```
   - Windows:
     ```bash
     run.bat
     ```
     或
     ```cmd
     streamlit run app.py
     ```

5. 🌐 在浏览器中访问 http://localhost:8501

### 🐳 方法二：Docker 部署

#### 📋 前提条件
- 🐳 安装 Docker 和 Docker Compose

#### 🚢 使用 Docker Compose 部署
1. 📋 克隆或下载项目到本地
2. 📂 进入项目目录
3. 🏗️ 构建并启动容器
   ```bash
   docker-compose up -d
   ```
   *(注意：容器将以非 root 用户运行以提高安全性)*
4. 🌐 在浏览器中访问 http://localhost:8501

#### 🐳 仅使用 Docker 部署
1. 📋 克隆或下载项目到本地
2. 📂 进入项目目录
3. 🏗️ 构建 Docker 镜像
   ```bash
   docker build -t fiscal-salary-processor .
   ```
4. 🚀 运行 Docker 容器
   ```bash
   docker run -p 8501:8501 fiscal-salary-processor
   ```
5. 🌐 在浏览器中访问 http://localhost:8501

---

## 📖 使用指南

### 🔄 基本流程

1. ⚙️ 在侧边栏设置单位名称和工资表日期
2. 📤 上传需要处理的源数据工资表（可多选）
3. 📤 上传扣款项表
4. 📤 上传字段映射规则文件（JSON格式）
5. 📤 上传导出表字段模板（可选）
6. 🔍 在"字段匹配关系设置"中选择用于匹配规则的字段名
7. 🚀 点击"开始处理数据"按钮
8. 📥 处理完成后下载生成的报表

### 📁 目录结构

```
📁 项目根目录
├── 📄 .dockerignore             # Docker 忽略文件
├── 📄 .gitignore                # Git 忽略文件 (若存在)
├── 📄 Dockerfile                # Docker 构建文件
├── 📄 app.py                    # 主应用程序
├── 📄 docker-compose.yml        # Docker Compose 配置
├── 📄 fiscal_report_full_script.py # 核心处理逻辑
├── 📄 font_cache.py             # 字体缓存处理 (若仍在使用)
├── 📄 package-lock.json         # Node.js 依赖锁定文件 (若相关)
├── 📄 requirements.txt          # Python 依赖包列表
├── 📄 run.bat                   # Windows 启动脚本
├── 📄 run.sh                    # Linux/Mac 启动脚本
├── 📁 config/                   # 配置文件目录 (JSON 规则等)
├── 📁 input/                    # 输入数据示例
├── 📄 使用指南.md               # 详细使用说明
├── 📄 开发指南.md               # 开发者相关信息
├── 📄 开发时间评估.md           # 项目时间相关
├── 📄 性能优化建议.md           # 性能相关建议
└── 📄 README.md                 # 项目说明文档 (本文档)
```

### 📝 映射规则文件说明

映射规则使用JSON格式定义，基本结构如下：

```json
{
  "field_mappings": [
    {
      "人员身份": "公务员",
      "编制": "行政编制",
      "mappings": [
        {
          "source_field": "源字段名1",
          "target_field": "目标字段名1"
        },
        {
          "source_fields": ["源字段A", "源字段B"],
          "calculation": "源字段A + 源字段B",
          "target_field": "目标字段名2"
        }
      ]
    }
  ]
}
```

---

## ⚠️ 注意事项

1. 📊 确保所有Excel文件使用.xlsx格式（不支持.xls）
2. 🔍 字段映射规则文件必须是有效的JSON格式
3. 👤 扣款表必须包含"姓名"或"人员姓名"列
4. 🔑 源数据表需要包含用于匹配规则的字段（如"人员身份"或"岗位类别"）

## 📞 技术支持

